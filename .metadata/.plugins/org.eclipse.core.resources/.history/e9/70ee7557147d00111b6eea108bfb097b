package net.onamap.android;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.URL;
import java.util.Map;
import java.util.concurrent.ExecutionException;

import org.apache.http.Header;
import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.client.methods.HttpRequestBase;
import org.apache.http.impl.client.DefaultHttpClient;

import com.handstandtech.restclient.server.auth.Authenticator;
import com.handstandtech.restclient.server.impl.RESTClientBaseImpl;
import com.handstandtech.restclient.shared.model.RESTResult;
import com.handstandtech.restclient.shared.model.RequestAuthentication;
import com.handstandtech.restclient.shared.model.RequestMethod;

/**
 * Uses App Engine's URL Fetch Classes
 * 
 * @author Sam Edwards
 * @version 2011.03.09
 */
public class RESTClientCommonsURLFetchImpl extends RESTClientBaseImpl {

	public RESTClientCommonsURLFetchImpl() {
		super();
	}

	protected RESTResult internalDoRequest(RequestMethod method,
			String urlString, Authenticator auth, byte[] payload,
			Map<String, String> requestHeaders) throws IOException {
		RESTResult result = new RESTResult();
		result.setUrl(urlString);

		// create an HTTP request to a protected resource
		HttpRequestBase request = null;

		switch (method) {
		case GET:
			request = new HttpGet(urlString);
			break;
		case POST:
			request = new HttpPost(urlString);
			break;

		}

		// send the request
		HttpClient httpClient = new DefaultHttpClient();

		if (requestHeaders != null) {
			for (String key : requestHeaders.keySet()) {
				String value = requestHeaders.get(key);
				request.addHeader(key, value);
			}
		}

		// Authenticate if required
		if (auth != null) {
			auth.authenticate(request);
			result.setRequestAuthentication(auth.getRequestAuthenticationType());
		} else {
			result.setRequestAuthentication(RequestAuthentication.NONE);
		}

		HttpResponse response = httpClient.execute(request);

		// Examine the response status
		System.out.println(response.getStatusLine());

		try {

			// Get hold of the response entity
			HttpEntity entity = response.getEntity();

			InputStream inputStream = entity.getContent();

			InputStreamReader inputStreamReader = new InputStreamReader(
					inputStream, "UTF-8");
			BufferedReader reader = new BufferedReader(inputStreamReader);
			String line = null;
			StringBuffer responseBody = new StringBuffer();
			while ((line = reader.readLine()) != null) {
				responseBody.append(line + "\n");
			}

			result.setResponseBody(responseBody.toString());

			// 200, 404, 500, etc
			int responseCode = response.getStatusLine().getStatusCode();
			result.setResponseCode(responseCode);

			Header[] responseHeaders = response.getAllHeaders();
			for (Header header : responseHeaders) {
				String headerName = header.getName();
				String headerValue = header.getValue();
				result.addResponseHeader(headerName, headerValue);
			}

		} catch (IOException e) {
			log.error(e.getMessage(), e);
		}

		return result;
	}
}
